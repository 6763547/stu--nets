
<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ПродуктЛист - Список покупок</title>
    <meta name="description" content="Простой список покупок с поиском по каталогу продуктов." />
    <meta name="author" content="Скопинцев Михаил Николаевич" />
    <meta property="og:image" content="/og-image.png" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    
    <!-- Preconnect to CDNs -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Mobile specific meta -->
    <meta name="theme-color" content="#1E88E5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- App styles -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <style>
      :root {
        --primary: #1E88E5;
        --background: #ffffff;
        --foreground: #121212;
        --muted: #f1f5f9;
        --muted-foreground: #64748b;
        --border: #e2e8f0;
      }
      
      body {
        font-family: 'Inter', sans-serif;
        background-color: var(--background);
        color: var(--foreground);
      }
      
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
      }
      
      .animate-fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      /* Header styles */
      .header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 50;
        transition: all 0.3s;
        padding: 0.75rem 0;
      }
      
      .header-scrolled {
        background-color: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(4px);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      
      /* Button styles */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.375rem;
        font-weight: 500;
        transition: all 0.2s;
        padding: 0.5rem 1rem;
        cursor: pointer;
      }
      
      .btn-primary {
        background-color: var(--primary);
        color: white;
      }
      
      .btn-primary:hover {
        opacity: 0.9;
      }
      
      .btn-ghost {
        background-color: transparent;
        color: var(--foreground);
      }
      
      .btn-ghost:hover {
        background-color: var(--muted);
      }
      
      /* Product item styles */
      .product-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
        transition: all 0.2s;
      }
      
      .product-item:hover {
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        background-color: var(--muted);
      }
      
      .product-item-selected {
        border-left: 4px solid var(--primary);
        opacity: 0.7;
      }
      
      /* Navigation bar */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: white;
        border-top: 1px solid var(--border);
        z-index: 50;
        transition: transform 0.3s;
      }
      
      .bottom-nav-hidden {
        transform: translateY(100%);
      }
      
      /* Form elements */
      .input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border);
        border-radius: 0.375rem;
        transition: all 0.2s;
      }
      
      .input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(30, 136, 229, 0.2);
      }
      
      /* For line-through on checked items */
      .line-through {
        text-decoration: line-through;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <!-- Content will be loaded here -->
      <div class="min-h-screen pb-16">
        <!-- Header -->
        <header id="header" class="header">
          <div class="container mx-auto flex justify-between items-center">
            <a href="#" class="text-xl md:text-2xl font-semibold text-primary">ПродуктЛист</a>
            
            <!-- Mobile menu button -->
            <div class="md:hidden">
              <button id="menuButton" class="btn btn-ghost p-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
              </button>
            </div>
            
            <!-- Desktop navigation -->
            <nav class="hidden md:flex space-x-4">
              <a href="#" class="btn btn-primary" id="listLink">Мой список</a>
              <a href="#catalog" class="btn btn-ghost" id="catalogLink">Каталог</a>
              <a href="#authors" class="btn btn-ghost" id="authorsLink">Авторы</a>
            </nav>
            
            <!-- Mobile navigation dropdown -->
            <div id="mobileMenu" class="hidden absolute top-full left-0 right-0 bg-white shadow-md py-2 animate-fade-in">
              <div class="flex flex-col space-y-1 px-4">
                <a href="#" class="btn btn-primary w-full text-left">Мой список</a>
                <a href="#catalog" class="btn btn-ghost w-full text-left">Каталог</a>
                <a href="#authors" class="btn btn-ghost w-full text-left">Авторы</a>
              </div>
            </div>
          </div>
        </header>
        
        <!-- Main content -->
        <main class="container pt-24 pb-16 animate-fade-in">
          <!-- Pages will be loaded here -->
          <div id="listPage" class="w-full max-w-2xl mx-auto">
            <div class="mb-6">
              <div class="relative w-full">
                <div class="flex w-full items-center space-x-2">
                  <input 
                    type="text" 
                    id="searchInput"
                    placeholder="Найти продукт..." 
                    class="input"
                  />
                </div>
                <div id="searchResults" class="hidden absolute z-10 mt-1 w-full bg-white rounded-md shadow-lg border"></div>
              </div>
            </div>
            
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-semibold">Мой список покупок</h2>
              <div class="flex space-x-2">
                <button id="refreshPrices" class="btn btn-ghost text-sm">Обновить цены</button>
                <button id="clearChecked" class="btn btn-ghost text-sm" disabled>Удалить купленные</button>
                <button id="clearAll" class="btn btn-ghost text-sm hidden">Очистить всё</button>
              </div>
            </div>
            
            <div id="productGroups"></div>
            
            <div id="totalPrice" class="mt-6 p-4 border border-border rounded-lg hidden">
              <div class="flex justify-between items-center">
                <h3 class="font-medium">Итого:</h3>
                <p id="totalPriceValue" class="font-medium">0.00 ₽</p>
              </div>
            </div>
          </div>
          
          <div id="catalogPage" class="hidden w-full max-w-6xl mx-auto">
            <div class="mb-6">
              <input
                type="text"
                id="catalogSearch"
                placeholder="Найти в каталоге..."
                class="input max-w-md"
              />
            </div>
            
            <div class="flex flex-col md:flex-row gap-6">
              <!-- Category sidebar -->
              <div class="w-full md:w-64 flex-shrink-0">
                <h2 class="text-lg font-medium mb-3">Категории</h2>
                <div id="categoriesList" class="space-y-1 bg-gray-100 rounded-lg p-2"></div>
              </div>
              
              <!-- Products grid -->
              <div class="flex-grow">
                <h2 id="categoryTitle" class="text-lg font-medium mb-3">Продукты</h2>
                <div id="productsList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
              </div>
            </div>
          </div>
          
          <div id="authorsPage" class="hidden">
            <div class="max-w-md mx-auto bg-white rounded-lg shadow-sm p-6">
              <h1 class="text-2xl font-bold text-center mb-6">Информация о проекте</h1>
              
              <div class="space-y-4">
                <div class="text-center">
                  <h2 class="text-xl font-semibold">Автор</h2>
                  <p class="mt-2">Скопинцев Михаил Николаевич</p>
                </div>
                
                <div class="text-center">
                  <h2 class="text-xl font-semibold">Учебное заведение</h2>
                  <p class="mt-2">МОБУ СОШ №1</p>
                </div>
                
                <div class="text-center">
                  <h2 class="text-xl font-semibold">Проект</h2>
                  <p class="mt-2">Индивидуальный проект, 11 класс</p>
                </div>
              </div>
              
              <div class="mt-8 flex justify-center">
                <button id="backButton" class="btn btn-primary">Назад</button>
              </div>
            </div>
          </div>
        </main>
      </div>
      
      <!-- Bottom navigation -->
      <nav id="bottomNav" class="bottom-nav">
        <div class="flex justify-around items-center h-16">
          <a href="#" class="flex flex-col items-center justify-center w-full h-full text-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 12H3"></path><path d="m16 6-3.5 3.5 3.5 3.5"></path><path d="M8 6h10a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H8"></path></svg>
            <span class="text-xs mt-1">Список</span>
          </a>
          
          <a href="#catalog" class="flex flex-col items-center justify-center w-full h-full text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="6" height="6" x="3" y="3" rx="1"></rect><path d="M7 17v.01"></path><path d="M17 7v.01"></path><rect width="6" height="6" x="3" y="15" rx="1"></rect><rect width="6" height="6" x="15" y="3" rx="1"></rect><rect width="6" height="6" x="15" y="15" rx="1"></rect></svg>
            <span class="text-xs mt-1">Каталог</span>
          </a>
          
          <a href="#authors" class="flex flex-col items-center justify-center w-full h-full text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <span class="text-xs mt-1">Авторы</span>
          </a>
        </div>
      </nav>
    </div>

    <!-- IMPORTANT: DO NOT REMOVE THIS SCRIPT TAG OR THIS VERY COMMENT! -->
    <script src="https://cdn.gpteng.co/gptengineer.js" type="module"></script>
    
    <script>
      // Mock catalog data
      const mockCatalog = [
        {
          id: "fruits",
          name: "Фрукты и ягоды",
          products: [
            { id: "apple", name: "Яблоки", unit: "кг", category: "Фрукты и ягоды" },
            { id: "banana", name: "Бананы", unit: "кг", category: "Фрукты и ягоды" },
            { id: "orange", name: "Апельсины", unit: "кг", category: "Фрукты и ягоды" },
            { id: "strawberry", name: "Клубника", unit: "кг", category: "Фрукты и ягоды" },
            { id: "grape", name: "Виноград", unit: "кг", category: "Фрукты и ягоды" },
          ]
        },
        {
          id: "vegetables",
          name: "Овощи",
          products: [
            { id: "potato", name: "Картофель", unit: "кг", category: "Овощи" },
            { id: "tomato", name: "Помидоры", unit: "кг", category: "Овощи" },
            { id: "cucumber", name: "Огурцы", unit: "кг", category: "Овощи" },
            { id: "carrot", name: "Морковь", unit: "кг", category: "Овощи" },
            { id: "onion", name: "Лук", unit: "кг", category: "Овощи" },
          ]
        },
        {
          id: "dairy",
          name: "Молочные продукты",
          products: [
            { id: "milk", name: "Молоко", unit: "л", category: "Молочные продукты" },
            { id: "cheese", name: "Сыр", unit: "кг", category: "Молочные продукты" },
            { id: "yogurt", name: "Йогурт", unit: "шт", category: "Молочные продукты" },
            { id: "butter", name: "Масло", unit: "шт", category: "Молочные продукты" },
            { id: "cream", name: "Сметана", unit: "шт", category: "Молочные продукты" },
          ]
        },
        {
          id: "meat",
          name: "Мясо и птица",
          products: [
            { id: "beef", name: "Говядина", unit: "кг", category: "Мясо и птица" },
            { id: "pork", name: "Свинина", unit: "кг", category: "Мясо и птица" },
            { id: "chicken", name: "Курица", unit: "кг", category: "Мясо и птица" },
            { id: "turkey", name: "Индейка", unit: "кг", category: "Мясо и птица" },
            { id: "sausage", name: "Колбаса", unit: "шт", category: "Мясо и птица" },
          ]
        }
      ];

      // State management
      const LOCAL_STORAGE_KEY = 'product-list-items';
      let products = [];
      let activeCategory = mockCatalog[0]?.id || null;
      let searchQuery = '';
      let catalogSearchQuery = '';
      let lastScrollY = 0;
      let isBottomNavVisible = true;

      // DOM elements
      const header = document.getElementById('header');
      const menuButton = document.getElementById('menuButton');
      const mobileMenu = document.getElementById('mobileMenu');
      const listPage = document.getElementById('listPage');
      const catalogPage = document.getElementById('catalogPage');
      const authorsPage = document.getElementById('authorsPage');
      const productGroups = document.getElementById('productGroups');
      const searchInput = document.getElementById('searchInput');
      const searchResults = document.getElementById('searchResults');
      const clearChecked = document.getElementById('clearChecked');
      const clearAll = document.getElementById('clearAll');
      const refreshPrices = document.getElementById('refreshPrices');
      const totalPrice = document.getElementById('totalPrice');
      const totalPriceValue = document.getElementById('totalPriceValue');
      const bottomNav = document.getElementById('bottomNav');
      const categoriesList = document.getElementById('categoriesList');
      const productsList = document.getElementById('productsList');
      const categoryTitle = document.getElementById('categoryTitle');
      const catalogSearch = document.getElementById('catalogSearch');
      const backButton = document.getElementById('backButton');

      // Initialize app
      document.addEventListener('DOMContentLoaded', () => {
        loadProducts();
        renderProducts();
        renderCategories();
        setupEventListeners();
        handleHashChange();
      });

      // Load products from localStorage
      function loadProducts() {
        const savedProducts = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (savedProducts) {
          try {
            products = JSON.parse(savedProducts);
          } catch (error) {
            console.error('Error parsing saved products:', error);
            products = [];
          }
        }
      }

      // Save products to localStorage
      function saveProducts() {
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(products));
      }

      // Generate a UUID
      function generateId() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          var r = Math.random() * 16 | 0,
              v = c === 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }

      // Setup event listeners
      function setupEventListeners() {
        // Scroll event for header
        window.addEventListener('scroll', handleScroll);
        
        // Hash change for navigation
        window.addEventListener('hashchange', handleHashChange);
        
        // Menu button
        menuButton.addEventListener('click', toggleMobileMenu);
        
        // Search input
        searchInput.addEventListener('input', handleSearchInput);
        searchInput.addEventListener('focus', function() {
          if (searchInput.value.length >= 2) {
            showSearchResults();
          }
        });
        
        // Catalog search
        catalogSearch.addEventListener('input', function() {
          catalogSearchQuery = this.value;
          renderProductsList();
        });
        
        // Clear buttons
        clearChecked.addEventListener('click', handleClearChecked);
        clearAll.addEventListener('click', handleClearAll);
        
        // Refresh prices
        refreshPrices.addEventListener('click', handleRefreshPrices);
        
        // Back button in authors page
        backButton.addEventListener('click', function() {
          window.history.back();
        });
        
        // Close search results when clicking outside
        document.addEventListener('click', function(e) {
          if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.classList.add('hidden');
          }
        });
      }

      // Handle scroll for header styling and bottom nav visibility
      function handleScroll() {
        const currentScrollY = window.scrollY;
        
        // Header styling
        if (currentScrollY > 10) {
          header.classList.add('header-scrolled');
        } else {
          header.classList.remove('header-scrolled');
        }
        
        // Bottom nav visibility
        if (currentScrollY > lastScrollY && currentScrollY > 100) {
          if (isBottomNavVisible) {
            bottomNav.classList.add('bottom-nav-hidden');
            isBottomNavVisible = false;
          }
        } else {
          if (!isBottomNavVisible) {
            bottomNav.classList.remove('bottom-nav-hidden');
            isBottomNavVisible = true;
          }
        }
        
        lastScrollY = currentScrollY;
      }

      // Toggle mobile menu
      function toggleMobileMenu() {
        mobileMenu.classList.toggle('hidden');
      }

      // Handle hash change for navigation
      function handleHashChange() {
        const hash = window.location.hash || '#';
        
        // Hide all pages
        listPage.classList.add('hidden');
        catalogPage.classList.add('hidden');
        authorsPage.classList.add('hidden');
        
        // Update bottom nav
        const navLinks = bottomNav.querySelectorAll('a');
        navLinks.forEach(link => {
          link.classList.remove('text-primary');
          link.classList.add('text-gray-500');
        });
        
        // Show page based on hash
        if (hash === '#catalog') {
          catalogPage.classList.remove('hidden');
          navLinks[1].classList.remove('text-gray-500');
          navLinks[1].classList.add('text-primary');
          renderCategories();
          renderProductsList();
        } else if (hash === '#authors') {
          authorsPage.classList.remove('hidden');
          navLinks[2].classList.remove('text-gray-500');
          navLinks[2].classList.add('text-primary');
        } else {
          // Default to list page
          listPage.classList.remove('hidden');
          navLinks[0].classList.remove('text-gray-500');
          navLinks[0].classList.add('text-primary');
          renderProducts();
        }
        
        // Close mobile menu
        mobileMenu.classList.add('hidden');
      }

      // Handle search input
      function handleSearchInput() {
        searchQuery = searchInput.value;
        
        if (searchQuery.length >= 2) {
          const results = searchProducts(searchQuery);
          renderSearchResults(results);
          showSearchResults();
        } else {
          searchResults.classList.add('hidden');
        }
      }

      // Show search results
      function showSearchResults() {
        if (searchQuery.length >= 2) {
          searchResults.classList.remove('hidden');
        }
      }

      // Search products
      function searchProducts(query) {
        if (!query || query.length < 2) return [];
        
        const lowerQuery = query.toLowerCase();
        let results = [];
        
        mockCatalog.forEach(category => {
          category.products.forEach(product => {
            if (product.name.toLowerCase().includes(lowerQuery)) {
              results.push({ ...product });
            }
          });
        });
        
        return results;
      }

      // Render search results
      function renderSearchResults(results) {
        searchResults.innerHTML = '';
        
        if (results.length === 0) {
          searchResults.innerHTML = '<div class="p-4 text-center text-gray-500">Ничего не найдено</div>';
          return;
        }
        
        const ul = document.createElement('ul');
        ul.className = 'py-1 max-h-60 overflow-auto';
        
        results.forEach(product => {
          const li = document.createElement('li');
          li.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer flex justify-between items-center';
          li.innerHTML = `
            <span>${product.name}</span>
            <button class="btn btn-ghost p-1">+</button>
          `;
          li.addEventListener('click', () => addProduct(product));
          ul.appendChild(li);
        });
        
        searchResults.appendChild(ul);
      }

      // Add product to list
      function addProduct(product) {
        // Check if product already exists
        const existingProduct = products.find(p => p.name === product.name);
        
        if (existingProduct) {
          // Update quantity if it exists
          existingProduct.quantity += 1;
          showToast(`${product.name} теперь ${existingProduct.quantity} ${product.unit}`);
        } else {
          // Add as new product
          const newProduct = {
            ...product,
            id: generateId(),
            quantity: 1,
            checked: false,
          };
          products.push(newProduct);
          showToast(`${product.name} добавлен в список`);
        }
        
        saveProducts();
        renderProducts();
        searchInput.value = '';
        searchResults.classList.add('hidden');
        
        // Fetch price for the new product
        fetchProductPrices([product.name]);
      }

      // Update product
      function updateProduct(id, updates) {
        products = products.map(product => 
          product.id === id ? { ...product, ...updates } : product
        );
        
        saveProducts();
        renderProducts();
      }

      // Remove product
      function removeProduct(id) {
        products = products.filter(product => product.id !== id);
        saveProducts();
        renderProducts();
        showToast('Продукт удален из списка');
      }

      // Handle clear checked products
      function handleClearChecked() {
        products = products.filter(product => !product.checked);
        saveProducts();
        renderProducts();
        showToast('Приобретенные продукты удалены из списка');
      }

      // Handle clear all products
      function handleClearAll() {
        if (confirm('Вы уверены, что хотите очистить весь список?')) {
          products = [];
          saveProducts();
          renderProducts();
          showToast('Все продукты удалены из списка');
        }
      }

      // Render products
      function renderProducts() {
        productGroups.innerHTML = '';
        
        // Update button states
        clearChecked.disabled = !products.some(p => p.checked);
        clearAll.classList.toggle('hidden', products.length === 0);
        totalPrice.classList.toggle('hidden', products.length === 0);
        
        if (products.length === 0) {
          productGroups.innerHTML = `
            <div class="text-center py-12 bg-gray-100 rounded-lg">
              <p class="text-gray-500 mb-2">Ваш список пуст</p>
              <p class="text-sm text-gray-500">Добавьте продукты с помощью поиска или из каталога</p>
            </div>
          `;
          return;
        }
        
        // Group products by category
        const groupedProducts = products.reduce((groups, product) => {
          const category = product.category || 'Другое';
          if (!groups[category]) {
            groups[category] = [];
          }
          groups[category].push(product);
          return groups;
        }, {});
        
        // Render product groups
        Object.entries(groupedProducts).forEach(([category, categoryProducts]) => {
          const groupDiv = document.createElement('div');
          groupDiv.className = 'mb-8';
          
          const categoryTitle = document.createElement('h3');
          categoryTitle.className = 'text-lg font-medium mb-3';
          categoryTitle.textContent = category;
          
          const productsDiv = document.createElement('div');
          productsDiv.className = 'space-y-2';
          
          categoryProducts.forEach(product => {
            const productItem = createProductItem(product);
            productsDiv.appendChild(productItem);
          });
          
          groupDiv.appendChild(categoryTitle);
          groupDiv.appendChild(productsDiv);
          productGroups.appendChild(groupDiv);
        });
        
        // Update total price
        updateTotalPrice();
      }

      // Create product item
      function createProductItem(product) {
        const div = document.createElement('div');
        div.className = `product-item ${product.checked ? 'product-item-selected' : ''}`;
        
        const inputId = `product-${product.id}`;
        
        div.innerHTML = `
          <input 
            type="checkbox" 
            id="${inputId}" 
            ${product.checked ? 'checked' : ''} 
            class="mr-3"
          />
          
          <div class="flex-1">
            <h3 class="font-medium ${product.checked ? 'line-through' : ''}">
              ${product.name}
            </h3>
            ${product.price ? `
              <p class="text-sm text-gray-500">
                ${product.price} ₽ / ${product.unit}
              </p>
            ` : ''}
          </div>
          
          <div class="flex items-center space-x-2">
            <span class="w-20 text-center cursor-pointer quantity-span">
              ${product.quantity} ${product.unit}
            </span>
            
            <button class="btn btn-ghost p-1 text-gray-500 remove-btn">
              ✕
            </button>
          </div>
        `;
        
        // Checkbox change event
        const checkbox = div.querySelector(`#${inputId}`);
        checkbox.addEventListener('change', function() {
          updateProduct(product.id, { checked: this.checked });
        });
        
        // Quantity click event
        const quantitySpan = div.querySelector('.quantity-span');
        quantitySpan.addEventListener('click', function() {
          const currentValue = product.quantity;
          const input = document.createElement('input');
          input.type = 'number';
          input.value = currentValue;
          input.className = 'w-20 h-8 text-center border rounded';
          input.min = '0.1';
          input.step = '0.1';
          
          this.parentNode.replaceChild(input, this);
          input.focus();
          
          const handleBlur = function() {
            const value = parseFloat(input.value);
            if (!isNaN(value) && value > 0) {
              updateProduct(product.id, { quantity: value });
            }
            
            input.removeEventListener('blur', handleBlur);
            input.removeEventListener('keydown', handleKeyDown);
          };
          
          const handleKeyDown = function(e) {
            if (e.key === 'Enter') {
              handleBlur();
            }
          };
          
          input.addEventListener('blur', handleBlur);
          input.addEventListener('keydown', handleKeyDown);
        });
        
        // Remove button event
        const removeBtn = div.querySelector('.remove-btn');
        removeBtn.addEventListener('click', function() {
          removeProduct(product.id);
        });
        
        return div;
      }

      // Update total price
      function updateTotalPrice() {
        const total = products.reduce((sum, product) => {
          if (product.price) {
            return sum + (product.price * product.quantity);
          }
          return sum;
        }, 0);
        
        totalPriceValue.textContent = `${total.toFixed(2)} ₽`;
      }

      // Render categories
      function renderCategories() {
        categoriesList.innerHTML = '';
        
        mockCatalog.forEach(category => {
          const filteredProducts = catalogSearchQuery
            ? category.products.filter(p => p.name.toLowerCase().includes(catalogSearchQuery.toLowerCase()))
            : category.products;
          
          if (catalogSearchQuery && filteredProducts.length === 0) {
            return;
          }
          
          const button = document.createElement('button');
          button.className = activeCategory === category.id
            ? 'btn btn-primary w-full justify-between'
            : 'btn btn-ghost w-full justify-between';
          button.innerHTML = `
            ${category.name}
            <span class="text-xs bg-gray-200 px-2 py-1 rounded-full">
              ${filteredProducts.length}
            </span>
          `;
          button.addEventListener('click', () => {
            activeCategory = category.id;
            renderCategories();
            renderProductsList();
          });
          
          categoriesList.appendChild(button);
        });
      }

      // Render products list
      function renderProductsList() {
        productsList.innerHTML = '';
        categoryTitle.textContent = 'Продукты';
        
        if (!activeCategory) {
          productsList.innerHTML = `
            <div class="text-center py-12 bg-gray-100 rounded-lg">
              <p class="text-gray-500">Выберите категорию</p>
            </div>
          `;
          return;
        }
        
        const category = mockCatalog.find(c => c.id === activeCategory);
        if (!category) return;
        
        categoryTitle.textContent = category.name;
        
        let filteredProducts = category.products;
        if (catalogSearchQuery) {
          filteredProducts = filteredProducts.filter(p => 
            p.name.toLowerCase().includes(catalogSearchQuery.toLowerCase())
          );
        }
        
        if (filteredProducts.length === 0) {
          productsList.innerHTML = `
            <div class="text-center py-12 bg-gray-100 rounded-lg">
              <p class="text-gray-500">Нет продуктов в этой категории</p>
            </div>
          `;
          return;
        }
        
        filteredProducts.forEach(product => {
          const div = document.createElement('div');
          div.className = 'p-4 border border-gray-200 rounded-lg hover:shadow-sm transition-all duration-200 flex flex-col';
          
          div.innerHTML = `
            <h3 class="font-medium">${product.name}</h3>
            <p class="text-sm text-gray-500 mb-4">Ед. изм: ${product.unit}</p>
            <button class="btn btn-primary mt-auto">
              Добавить в список
            </button>
          `;
          
          const button = div.querySelector('button');
          button.addEventListener('click', () => addProduct(product));
          
          productsList.appendChild(div);
        });
      }

      // Fetch product prices from bdex.ru
      async function fetchProductPrices(productNames) {
        if (productNames.length === 0) return;
        
        showToast('Загрузка цен...', 'info');
        
        try {
          // Simulating fetching prices from bdex.ru
          // In a real implementation, you would make an actual network request
          const prices = {};
          
          productNames.forEach(name => {
            // Generate random price for demo purposes
            prices[name] = (Math.random() * 100 + 20).toFixed(2);
          });
          
          // Update product prices
          products = products.map(product => {
            if (prices[product.name]) {
              return { ...product, price: parseFloat(prices[product.name]) };
            }
            return product;
          });
          
          saveProducts();
          renderProducts();
          showToast('Цены обновлены', 'success');
        } catch (error) {
          console.error('Failed to fetch prices:', error);
          showToast('Не удалось загрузить цены', 'error');
        }
      }

      // Handle refresh prices
      function handleRefreshPrices() {
        if (products.length === 0) return;
        
        const productNames = products.map(p => p.name);
        fetchProductPrices(productNames);
      }

      // Show toast notification
      function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-20 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-md text-white text-sm z-50 animate-fade-in ${
          type === 'error' ? 'bg-red-500' : 
          type === 'info' ? 'bg-blue-500' : 
          'bg-green-500'
        }`;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transition = 'opacity 0.3s';
          
          setTimeout(() => {
            document.body.removeChild(toast);
          }, 300);
        }, 3000);
      }
    </script>
  </body>
</html>
